---
title: 'Chapter 4: Worked Example'
author: "Jules Lanari-Collard"
date: "2024-08-09"
bibliography: ../report/references.bib
output: latex_fragment
---

This chapter uses data from a cross-over study by Dai, Lov, Martin-Arrowsmith et al. \cite{dai2022insect}. The trial measured various outcomes after ingesting a protein-based beverage, comparing between beef- or insect-derived proteins. 20 subjects were randomised into either the cricket-beef (C-B) sequence or the beef-cricket (B-C) sequence. For the following examples, we focus on data collected on insulin levels 300 minutes after ingestion.

We will apply the methods described in the preceding chapters to the data, in order to determine whether there is a difference between the beef- or insect-derived proteins (in terms of resulting insulin levels).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      strip.white = TRUE)

library(tidyverse)
library(readxl)
library(kableExtra)
library(xtable)
library(ggpmisc)
library(rstatix)
```
# Standard Cross-over Design

## Data Structure

Most data manipulation and visualisation is performed using the `tidyverse` package (which includes `ggplot`); other packages used are indicated where applicable. It is important that the columns for subject, sequence, period and treatment are treated as factors (instead of continuous).

The data were collected in 'long' format, where we have a column for period and a column for the measurement (see table \ref{tab:data-long-demo}). For some plots it is easier for the data to be in 'wide' format (see table \ref{tab:data-wide-demo}); this can easily be achieved with `tidyr::pivot_wider()`.
```{r data-import, echo=FALSE}
data <- read_xlsx("../data/CrossOverData2.xlsx") %>%
  mutate(across(Subject:treat, as_factor)) %>%
  select(-Pre) %>%
  rename(Treatment = "treat", Insulin = "Post")
```

```{r data-long-demo, echo=FALSE}
data %>% arrange(Subject) %>% head(5) %>%
  kbl(caption = "Subsample of Data in 'Long' Format",
      booktabs = TRUE,
      positioning = "ht") %>%
  kable_paper()
```

```{r data-widening}
data.wide <- data %>%
  pivot_wider(id_cols = c(Subject, Sequence),
              names_from = Period, values_from = Insulin,
              names_prefix = "Period")
```

```{r data-wide-demo, echo=FALSE}
data.wide %>% arrange(Subject) %>% head(5) %>%
  kbl(caption="Subsample of Data in 'Wide' Format",
      booktabs = TRUE,
      positioning = "h") %>%
  kable_paper()
```

```{r means-medians, echo=FALSE}
means <- data.wide %>%
  group_by(Sequence) %>%
  summarise(Period1 = mean(Period1),
            Period2 = mean(Period2))

medians <- data.wide %>%
  group_by(Sequence) %>%
  summarise(Period1 = median(Period1),
            Period2 = median(Period2))

medians.long <- medians %>%
  rename(`1` = "Period1", `2` = "Period2") %>%
  pivot_longer(cols = c(`1`, `2`), names_to = "Period", values_to = "Insulin",
               names_transform = as_factor)
```

## Summarising the Data

Now we can move on to the summary tables and plots, to gain a better understanding of the data. First, the summary table; initial summaries by sequence and period can be easily calculated using `dplyr::summarise()`, but the aggregated total summaries (total, by period and by sequence) must be calculated separately and joined to compile the full summary table.
```{r summary-table-construction}
# Summary by period & sequence
summary.period.sequence <- data.wide %>%
  group_by(Sequence) %>%
  summarise(Subjects = n(),
            meanPeriod1 = mean(Period1),
            sdPeriod1 = sd(Period1),
            meanPeriod2 = mean(Period2),
            sdPeriod2 = sd(Period2))

# Summary by sequence
summary.sequence <- data %>%
  group_by(Sequence) %>%
  summarise(meanOverall = mean(Insulin),
            sdOverall = sd(Insulin))

# Summary by period
summary.period <- data %>%
  group_by(Period) %>%
  summarise(meanPeriod = mean(Insulin),
            sdPeriod = sd(Insulin)) %>%
  pivot_wider(names_from = Period, values_from = c(meanPeriod, sdPeriod),
              names_sep = "") %>%
  mutate(Sequence = "Total", Subjects = n_distinct(data$Subject),
         meanOverall = mean(data$Insulin),
         sdOverall = sd(data$Insulin),
         .before = meanPeriod1)

# Combine tables together
table1 <- inner_join(summary.sequence, summary.period.sequence,
                     by = "Sequence") %>%
  bind_rows(summary.period) %>%
  relocate(Subjects, .after = Sequence)
```

```{r table1, echo=FALSE}
table1 %>%
  kbl(caption = "Summary Table",
      booktabs = TRUE,
      col.names = c("Sequence", "Subjects", rep(c("Mean","SD"), 3)),
      digits = 2) %>%
  add_header_above(c(" "=2,
                     "Overall"=2, "Period 1"=2, "Period 2"=2)) %>%
  row_spec(2, hline_after = TRUE) %>%
  column_spec(c(2, 4), border_right = TRUE) %>%
  kable_styling(latex_options = "scale_down")
```
### Visualisations

We start with a boxplot (see figure \ref{fig:summary-boxplot}) and groups-by-periods plot (see figure \ref{fig:groups-by-periods}), summarising the results by sequence and period. The subject-profile plot (see figure \ref{fig:subject-profile}) provides a subject-level visualisation.
```{r summary-boxplot, fig.cap="Summary Boxplot", echo=FALSE}
ggplot(data = data, mapping = aes(x = Period, y = Insulin, col = Sequence)) +
  facet_wrap(~Sequence) +
  geom_boxplot(show.legend = FALSE) +
  theme_bw()
```

```{r groups-by-periods, fig.cap="Groups-by-Periods Plot", echo=FALSE}
ggplot(data = medians.long, mapping = aes(x = Period, y = Insulin, colour = Sequence)) +
  geom_line(aes(group = Sequence)) +
  geom_point() +
  labs(y = "Median Value") +
  theme_bw()
```

```{r subject-profile, fig.cap="Subject-Profile Plot", echo=FALSE}
ggplot(data = data,
       mapping = aes(x = Period, y = Insulin)) +
  facet_wrap(~Sequence) +
  geom_line(aes(group = Subject), alpha = 0.55) +
  geom_point(aes(col = Sequence), show.legend = FALSE) +
  theme_bw()
```

Now we examine potential treatment differences with figures \ref{fig:period-by-period} and \ref{fig:centroids}. Due to the relatively small sample size, it is difficult to extract any potential trends from the data at this stage. Notice, however, that there are a number of potential outliers in each sequence, which appear to be influencing the centroids (which are calculated using means).

```{r period-by-period, fig.cap = "Period-by-Period Plot", echo=FALSE}
ggplot(data = data.wide, mapping = aes(x = Period1, y = Period2, col = Sequence)) +
  facet_wrap(~Sequence) +
  geom_point(show.legend = FALSE) +
  geom_abline(slope=1,intercept=0) +
  labs(x="Period 1", y="Period 2") +
  theme_bw()
```

```{r centroids, fig.cap="Period-by-Period Plot with Centroids", echo=FALSE}
ggplot(data = data.wide, mapping = aes(x = Period1, y = Period2, col = Sequence)) +
  geom_point(show.legend = FALSE) +
  geom_point(data = means,
             mapping = aes(x = Period1, y = Period2),
             shape = "square", size = 5) +
  geom_abline(slope=1,intercept=0) +
  labs(x="Period 1", y="Period 2") +
  theme_bw()
```

Reconstructing the plot, using median centroids instead (see figure \ref{fig:centroids-median}), confirms this suspicion and provides more insight. We see that the median centroids appear on opposite sides of the line, with some vertical separation, indicating a potential difference between the treatments.

```{r centroids-median, fig.cap="Period-by-Period Plot with Median Centroids", echo=FALSE}
ggplot(data = data.wide, mapping = aes(x = Period1, y = Period2, col = Sequence)) +
  geom_point(show.legend = FALSE) +
  geom_point(data = medians,
             mapping = aes(x = Period1, y = Period2),
             shape = "square", size = 5) +
  geom_abline(slope=1,intercept=0) +
  labs(x="Period 1", y="Period 2") +
  theme_bw()
```

## Modelling for Treatment Differences
First we construct an ANOVA table, to verify that the other effects do not overly influence the data. This can be easily done using the built-in `aov()` function on the data in 'long' format, specifying the linear model equation as an argument. The ANOVA table itself can be obtained using the `summary()` function on the `aov` object. The resulting table is shown in table \ref{tab:anova-table}.

```{r}
anova.table <- aov(Insulin ~ Treatment + Period + Sequence + Subject, data = data) %>%
  summary()
```

```{r anova-table, echo=FALSE, fig.cap="ANOVA on Linear Model"}
anova.table %>% xtable(caption="ANOVA on Linear Model") %>%
  xtable2kable(booktabs=TRUE)
```

We see that none of the other effects are significant, so we can safely move on to test for treatment differences. The mixed model can be implemented using the `lme4::lmer()` function, in conjunction with the `lmerTest` package (for p-values). We specify the linear model as normal, with the `(1|Subject)` term specifying that Subject is a random effect.

```{r}
library(lme4)
library(lmerTest)
mixed.model <- lmer(Insulin ~ Treatment + Period + Sequence + (1 | Subject),
                    data = data)
```
```{r mixed-model-table, echo=FALSE}
kable(summary(mixed.model)$coefficients,
      booktabs=TRUE,
      caption = "Estimates for Mixed Model",
      digits = 2)
```
As shown in the model results table \ref{tab:mixed-model-table}, the treatment term is not significant, so at this stage we cannot conclude that there is a difference between the treatments.

### Verifying Assumptions
At this stage it is important to verify the assumptions of the model. The `broom.mixed::augment()` function adds columns to the original dataframe with the fitted values, residuals and more. This information can be used to verify the model assumptions, by constructing a plot of residuals against fitted values (figure \ref{fig:homoplot}), and a Q-Q plot (figure \ref{fig:qqplot}).

```{r}
library(broom.mixed)
mixed.model.metrics <- mixed.model %>% augment()
```

```{r homoplot, fig.cap="Verifying Homoscedasticity", echo=FALSE}
ggplot(data = mixed.model.metrics, mapping = aes(x = .fitted, y = .resid)) +
  geom_point() +
  geom_abline(slope = 0, linetype = "dashed") +
  scale_y_continuous(limits = symmetric_limits) +
  theme_bw() +
  labs(x = "Fitted Value", y = "Residual")
```

```{r qqplot, fig.cap="Q-Q Plot", echo=FALSE}
ggplot(data = mixed.model.metrics, mapping = aes(sample = .resid)) +
  geom_qq() +
  geom_qq_line() +
  labs(x = "Normal Quantiles", y = "Residuals") +
  theme_bw()
```

Excluding a few outliers, figures \ref{fig:homoplot} and \ref{fig:qqplot} show nothing to suggest that the assumptions of homoscedasticity and normality were violated.

### Adjusted Means
Finally, we can report the adjusted means. The `emmeans::emmeans()` function provides adjusted means, taking as input the model and variable by which to separate the means. The results are shown in table \ref{tab:emmeans-table}.

```{r}
library(emmeans)
emm <- emmeans(mixed.model, ~ Sequence)
```
```{r emmeans-table, echo=FALSE}
emm %>% kbl(caption = "LS Means",
            booktabs = TRUE,
            digits = 2)
```



# Using Baseline Measurements

## Data Structure

The study also measured insulin levels before ingestion, so we can incorporate these baseline measurements into the analysis. The format of the data with baseline (Pre) and post-ingestion insulin levels (Post) is shown in table \ref{tab:data-demo-baseline}. For summaries and modelling, we need the data also in 'longer' and 'wider' formats, shown in tables \ref{tab:data-wide-demo-baseline} and \ref{tab:data-long-demo-baseline}.

```{r data-import-baseline, include=FALSE}
data <- read_xlsx("../data/CrossOverData2.xlsx") %>%
  mutate(across(Subject:treat, as_factor)) %>%
  rename(Treatment = "treat")
```

```{r data-demo-baseline, echo=FALSE}
data %>% arrange(Subject) %>% head(5) %>%
  kbl(caption = "Subsample of Data with Baselines",
      booktabs = TRUE,
      positioning = "ht")
```

```{r data-manip-baseline}
data.long <- data %>%
  pivot_longer(cols = c(Pre,Post),
               names_to = "Measurement",
               values_to = "Insulin",
               names_transform = as_factor)

data.wide <- data %>%
  pivot_wider(id_cols = c(Subject, Sequence),
              names_from = Period, values_from = c(Pre, Post)) %>%
  relocate(Post_1, .after = "Pre_1")
```

```{r data-wide-demo-baseline, echo=FALSE}
data.wide %>% arrange(Subject) %>% head(5) %>%
  kbl(caption = "Subsample of Data with Baselines in 'Wider' Format",
      booktabs = TRUE,
      positioning = "ht")
```

```{r data-long-demo-baseline, echo=FALSE}
data.long %>% arrange(Subject, Period) %>% head(4) %>%
  kbl(caption = "Subsample of Data with Baselines in 'Longer' Format",
      booktabs = TRUE,
      positioning = "ht")
```
For modelling, we also need to calculate the difference in baselines for each subject. Using a host of functions from the `dplyr` package, we first calculate the difference in the 'wider' format, before using `pivot_longer()` to transform the data into the format needed for implementing the model. The resulting data is shown in table \ref{}

```{r baseline-diff}
data.baselines <- data.wide %>%
  mutate(baseline_diff = Pre_1 - Pre_2) %>%
  rename(`1` = "Post_1", `2` = "Post_2") %>%
  pivot_longer(cols = c(`1`,`2`), names_to = "Period", values_to = "Post",
               names_transform = as_factor) %>%
  select(Subject, Period, baseline_diff) %>% 
  inner_join(data, join_by(Subject == Subject, Period == Period)) %>%
  relocate(Sequence, .after = "Subject") %>%
  relocate(baseline_diff, .after = "Post")
```

```{r data-baseline-demo, echo=FALSE}
data.baselines %>% arrange(Subject) %>% head(5) %>%
  kbl(caption = "Subsample of Data with Baseline Differences",
      booktabs = TRUE,
      positioning = "ht")
```

```{r medians-baseline, include=FALSE}
medians <- data.wide %>%
  group_by(Sequence) %>%
  summarise(Period1 = median(Post_1),
            Period2 = median(Post_2))

medians.long <- medians %>%
  rename(`1` = "Period1", `2` = "Period2") %>%
  pivot_longer(cols = c(`1`, `2`), names_to = "Period", values_to = "Insulin",
               names_transform = as_factor)
```

```{r, include=FALSE}
# Summary by period & sequence
summary.period.sequence <- data.wide %>%
  group_by(Sequence) %>%
  summarise(Subjects = n(),
            meanPre1 = mean(Pre_1),
            sdPre1 = sd(Pre_1),
            meanPost1 = mean(Post_1),
            sdPost1 = sd(Post_1),
            meanPre2 = mean(Pre_2),
            sdPre2 = sd(Pre_2),
            meanPost2 = mean(Post_2),
            sdPost2 = sd(Post_2))

# Summary by sequence
summary.sequence <- data.long %>%
  group_by(Sequence, Measurement) %>%
  summarise(meanOverall = mean(Insulin),
            sdOverall = sd(Insulin)) %>%
  pivot_wider(names_from = Measurement, values_from = c(meanOverall, sdOverall),
              names_sep = "") %>%
  select(Sequence, meanOverallPre, sdOverallPre, meanOverallPost, sdOverallPost)

# Summary by period
summary.period <- data %>%
  group_by(Period) %>%
  summarise(meanPre = mean(Pre),
            sdPre = sd(Pre),
            meanPost = mean(Post),
            sdPost = sd(Post)) %>%
  pivot_wider(names_from = Period, values_from = meanPre:sdPost,
              names_sep = "") %>%
  mutate(Sequence = "Total", Subjects = n_distinct(data$Subject),
         meanOverallPre = mean(data$Pre),
         sdOverallPre = sd(data$Pre),
         meanOverallPost = mean(data$Post),
         sdOverallPost = sd(data$Post),
         .before = meanPre1)

summary.table <- inner_join(summary.sequence, summary.period.sequence,
                     by = "Sequence") %>%
  bind_rows(summary.period) %>%
  relocate(Subjects, .after = Sequence)
```

## Summarising with Baselines

The summary table can be expanded to include the baseline measurements, as shown in table \ref{tab:table1-baseline}.

```{r table1-baseline, echo=FALSE}
table1 %>%
  kbl(caption = "Summary Table with Baseline Values (Pre)",
               booktabs = TRUE,
      col.names = c("Sequence", "Subject", rep(c("Mean","SD"), 6)),
      digits = 2) %>%
  add_header_above(c(" "=2,
                     "Pre"=2, "Post"=2,
                     "Pre"=2, "Post"=2,
                     "Pre"=2, "Post"=2)) %>%
  add_header_above(c(" "=2, "Overall"=4, "Period 1"=4, "Period 2"=4)) %>%
  row_spec(2, hline_after = TRUE) %>%
  column_spec(c(2, 6), border_right = TRUE) %>%
  kable_styling(latex_options = "scale_down")
```

We can also extend the boxplot to incorporate the baseline measurements (see figure \ref{fig:boxplot-with-baseline}.

```{r boxplot-with-baseline, echo=FALSE}
ggplot(data = data.long, mapping = aes(x = Period, y = Insulin, col = Measurement)) +
  facet_wrap(~Sequence) +
  geom_boxplot() +
  theme_bw()
```


## Modelling with Baselines

First we construct the ANOVA table, this time including the baseline by period interaction, as shown in table \ref{tab:anova-table-baseline}.
```{r anova-baseline}
anova.table.baseline <- aov(Post ~ Treatment + Period * baseline_diff + Sequence + Subject,
                             data = data.baselines) %>%
  summary()
```

```{r anova-table-baseline, include=FALSE}
anova.table.baseline %>%
  xtable(caption = "ANOVA Table with Baseline Interaction") %>%
  xtable2kable(booktabs = TRUE)
```

We update the mixed model to include the period-by-baseline difference interaction. Estimates are shown in table \ref{tab:mixed-model-baseline}, and the updated LS means in table \ref{tab:emmeans-baseline}.

```{r}
mixed.model.baselines <- lmer(Post ~ Treatment + Period * baseline_diff + Sequence + (1|Subject),
              data = data.baselines)
```

```{r mixed-model-baseline, include=FALSE}
summary(mixed.model.baselines)$coefficients %>%
  kbl(caption="Mixed Model Estimates with Baseline Interaction",
      booktabs=TRUE,
      digits=2)
```

```{r emmeans-baseline, echo=FALSE}
emm.baselines <- emmeans(mixed.model.baselines, ~ Sequence)
emm.baselines %>% kbl(caption = "LS Means",
            booktabs = TRUE,
            digits = 2)
```

